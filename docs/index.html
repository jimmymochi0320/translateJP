<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hokkaido Fast Translator (CHT v3.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: 700; background-color: #eff6ff; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        .loader {
            border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden">

    <header class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm z-20">
        <h1 class="text-lg font-bold text-slate-800 tracking-wide">åŒ—æµ·é“æ¥µé€Ÿç¿»è­¯ â„ï¸</h1>
        <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-slate-600 active:bg-slate-100 rounded-full transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </header>

    <div id="settingsPanel" class="hidden absolute top-14 left-0 w-full bg-white p-4 border-b shadow-lg z-30 transition-all">
        <label class="block text-sm font-bold text-slate-700 mb-1">API Key è¨­å®š</label>
        <div class="flex gap-2">
            <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Š Key (AIza...)" 
                   class="flex-1 p-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="saveKey()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold active:bg-slate-900">å„²å­˜</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">*é‡‘é‘°å®‰å…¨å„²å­˜æ–¼æœ¬æ©Ÿ</p>
    </div>

    <div class="flex border-b bg-white">
        <button onclick="switchTab('text')" id="tabText" class="flex-1 py-4 text-center tab-active text-lg transition-colors">
            ğŸ“ æ–‡å­—äº’è­¯
        </button>
        <button onclick="switchTab('image')" id="tabImage" class="flex-1 py-4 text-center tab-inactive text-lg transition-colors">
            ğŸ“· åœ–ç‰‡ç§’è§£
        </button>
    </div>

    <main class="flex-1 overflow-y-auto p-4 bg-slate-50 relative">
        <div id="textView" class="space-y-4 h-full flex flex-col">
            <textarea id="textInput" placeholder="è¼¸å…¥ä¸­æ–‡è½‰æ—¥æ–‡ï¼Œæˆ–æ—¥æ–‡è½‰ä¸­æ–‡..." 
                      class="w-full h-40 p-4 text-lg border border-slate-200 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none resize-none transition"></textarea>
            
            <button onclick="translateText()" id="btnTranslateText" 
                    class="w-full py-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-lg font-bold rounded-xl shadow-lg active:scale-[0.98] transition flex justify-center items-center gap-2">
                ç¿»è­¯ (Translate)
            </button>

            <div id="textResult" class="hidden flex-1 bg-white p-4 rounded-xl border border-blue-100 shadow-sm mt-2 overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-blue-500 uppercase tracking-wider">Result</span>
                    <button onclick="copyResult('textOutput')" class="text-xs text-slate-400 hover:text-blue-500">è¤‡è£½</button>
                </div>
                <p id="textOutput" class="text-xl text-slate-800 font-medium leading-relaxed select-text"></p>
            </div>
        </div>

        <div id="imageView" class="hidden space-y-4 h-full flex flex-col">
            <label class="block w-full h-48 border-2 border-dashed border-slate-300 rounded-xl flex flex-col justify-center items-center cursor-pointer bg-white hover:bg-slate-50 transition relative overflow-hidden group">
                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                <div id="uploadPrompt" class="text-center group-hover:scale-105 transition">
                    <span class="text-4xl block mb-2">ğŸ“¸</span>
                    <span class="text-slate-500 font-medium">æ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡</span>
                </div>
                <img id="imagePreview" class="absolute inset-0 w-full h-full object-contain hidden bg-slate-900">
                <button id="reuploadBtn" class="hidden absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">é‡æ‹</button>
            </label>

            <button onclick="translateImage()" id="btnTranslateImage" disabled
                    class="w-full py-4 bg-slate-300 text-white text-lg font-bold rounded-xl shadow-none transition flex justify-center items-center gap-2 cursor-not-allowed">
                è«‹å…ˆé¸å–åœ–ç‰‡
            </button>

            <div id="imageResult" class="hidden flex-1 bg-white p-4 rounded-xl border border-blue-100 shadow-sm overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-blue-500 uppercase tracking-wider">ä¸­æ–‡è§£æçµæœ</span>
                    <button onclick="copyResult('imageOutput')" class="text-xs text-slate-400 hover:text-blue-500">è¤‡è£½</button>
                </div>
                <div id="imageOutput" class="text-base text-slate-800 leading-relaxed whitespace-pre-wrap"></div>
            </div>
        </div>
    </main>

    <script>
        // ================= CONFIGURATION =================
        // ä½¿ç”¨ç›®å‰æœ€ç©©å®šä¸”å¿«é€Ÿçš„ Flash ç‰ˆæœ¬ã€‚
        // å¦‚æœå …æŒè¦è©¦ 3.0 (ä¸ä¿è­‰ç©©å®š)ï¼Œå¯è‡ªè¡Œä¿®æ”¹ç‚º "gemini-3.0-flash-exp" æˆ–é¡ä¼¼åç¨±ã€‚
        const MODEL_NAME = "gemini-2.0-flash"; 
        
        let currentKey = localStorage.getItem("gemini_api_key");
        let compressedImageBase64 = null;

        // ================= INITIALIZATION =================
        if (currentKey) {
            document.getElementById('apiKeyInput').value = currentKey;
        } else {
            toggleSettings();
        }

        // ================= UI FUNCTIONS =================
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem("gemini_api_key", key);
                currentKey = key;
                toggleSettings();
                alert("âœ… é‡‘é‘°å·²å„²å­˜ï¼");
            } else {
                alert("âŒ è«‹è¼¸å…¥ API Key");
            }
        }

        function switchTab(tab) {
            const textView = document.getElementById('textView');
            const imageView = document.getElementById('imageView');
            const tabText = document.getElementById('tabText');
            const tabImage = document.getElementById('tabImage');

            if(tab === 'text') {
                textView.classList.remove('hidden');
                imageView.classList.add('hidden');
                tabText.className = "flex-1 py-4 text-center tab-active text-lg transition-colors";
                tabImage.className = "flex-1 py-4 text-center tab-inactive text-lg transition-colors";
            } else {
                textView.classList.add('hidden');
                imageView.classList.remove('hidden');
                tabText.className = "flex-1 py-4 text-center tab-inactive text-lg transition-colors";
                tabImage.className = "flex-1 py-4 text-center tab-active text-lg transition-colors";
            }
        }

        function copyResult(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½ï¼"));
        }

        // ================= IMAGE HANDLING =================
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1024; // å£“ç¸®ä»¥æå‡é€Ÿåº¦

                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const preview = document.getElementById('imagePreview');
                    preview.src = dataUrl;
                    preview.classList.remove('hidden');
                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('reuploadBtn').classList.remove('hidden');

                    const btn = document.getElementById('btnTranslateImage');
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');
                    btn.innerHTML = "è§£æåœ–ç‰‡å…§å®¹ (Analyze)";

                    compressedImageBase64 = dataUrl.split(',')[1];
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ================= TRANSLATION LOGIC =================
        async function translateText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) return alert("è«‹è¼¸å…¥æ–‡å­—ï¼");
            setLoading('btnTranslateText', true);
            
            try {
                const prompt = `You are a travel translator using gemini 3 technology.
                Detect language:
                - If Chinese (Traditional/Simplified) -> Translate to Japanese (Polite form).
                - If Japanese -> Translate to Traditional Chinese (Taiwan usage).
                - Output ONLY the translated text.
                Input: "${text}"`;

                const result = await callGemini(prompt);
                document.getElementById('textOutput').innerText = result;
                document.getElementById('textResult').classList.remove('hidden');
            } catch (e) {
                alert("éŒ¯èª¤ï¼š" + e.message);
            } finally {
                setLoading('btnTranslateText', false);
            }
        }

        async function translateImage() {
            if (!compressedImageBase64) return;
            setLoading('btnTranslateImage', true);
            
            try {
                // æ›´æ–°å¾Œçš„å¼·åŠ›ä¸­æ–‡æç¤ºè©
                const prompt = `You are a smart travel assistant for a Taiwanese in Hokkaido.
                Analyze this image and output a summary EXCLUSIVELY in Traditional Chinese (ç¹é«”ä¸­æ–‡).
                1. Identify key text (menu, signs) and translate it to Traditional Chinese.
                2. Explain the context practically for a traveler.
                3. Do not output English.`;

                const result = await callGeminiVision(prompt, compressedImageBase64);
                document.getElementById('imageOutput').innerText = result;
                document.getElementById('imageResult').classList.remove('hidden');
            } catch (e) {
                alert(e.message); // ç›´æ¥é¡¯ç¤ºè™•ç†éçš„ä¸­æ–‡éŒ¯èª¤è¨Šæ¯
            } finally {
                setLoading('btnTranslateImage', false);
            }
        }

        // ================= API CALLERS & ERROR HANDLING =================
        async function callGemini(textPrompt) {
            if (!currentKey) throw new Error("è«‹å…ˆè¨­å®š API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${currentKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] })
            });
            return parseResponse(response);
        }

        async function callGeminiVision(textPrompt, base64Image) {
            if (!currentKey) throw new Error("è«‹å…ˆè¨­å®š API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${currentKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: textPrompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });
            return parseResponse(response);
        }

        async function parseResponse(response) {
            if (!response.ok) {
                const err = await response.json();
                const errMsg = err.error?.message || "";

                // æ•æ‰ 429 Resource Exhausted éŒ¯èª¤ (é»å¤ªå¿«)
                if (response.status === 429 || errMsg.includes("Resource exhausted")) {
                    throw new Error("âš ï¸ æ‚¨é»å¤ªå¿«äº†ï¼å…è²»ç‰ˆ API éœ€è¦ä¼‘æ¯ä¸€ä¸‹ (ç´„ 20-30 ç§’)ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
                // æ•æ‰æ¨¡å‹ä¸å­˜åœ¨éŒ¯èª¤
                if(errMsg.includes("not found")) {
                    throw new Error("æ‰¾ä¸åˆ°æ­¤æ¨¡å‹ç‰ˆæœ¬ï¼Œè«‹ç¢ºèªç¨‹å¼ç¢¼ä¸­çš„ MODEL_NAME è¨­å®šã€‚");
                }
                // å…¶ä»–éŒ¯èª¤
                throw new Error(errMsg || "ç¶²è·¯é€£ç·šéŒ¯èª¤");
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            const originalText = btnId === 'btnTranslateText' ? 'ç¿»è­¯ (Translate)' : 'è§£æåœ–ç‰‡å…§å®¹ (Analyze)';
            
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="loader"></span> è™•ç†ä¸­...`;
                btn.classList.add('opacity-75');
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-75');
            }
        }
    </script>
</body>
</html>
